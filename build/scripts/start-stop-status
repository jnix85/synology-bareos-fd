#!/bin/bash

# Bareos File Daemon service management script for Synology DSM

BAREOS_USER="bareos"
BAREOS_HOME="/var/packages/bareos-fd/target"
BAREOS_BIN="$BAREOS_HOME/bin/bareos-fd"
BAREOS_CONFIG="$BAREOS_HOME/etc/bareos/bareos-fd.conf"
BAREOS_PID="/var/run/bareos-fd.pid"
BAREOS_LOG="/var/log/bareos-fd.log"

# Source Synology functions
source /pkgscripts/include/pkg_util.sh

case "$1" in
    start)
        echo "Starting Bareos File Daemon..."
        
        # Check if already running
        if [ -f "$BAREOS_PID" ] && kill -0 $(cat "$BAREOS_PID") 2>/dev/null; then
            echo "Bareos File Daemon is already running"
            exit 0
        fi
        
        # Create necessary directories
        mkdir -p /var/run /var/log
        chown "$BAREOS_USER:$BAREOS_USER" /var/run /var/log
        
        # Validate configuration
        if ! "$BAREOS_BIN" -t -c "$BAREOS_CONFIG" >/dev/null 2>&1; then
            echo "Configuration validation failed"
            exit 1
        fi
        
        # Start the daemon
        su - "$BAREOS_USER" -c "$BAREOS_BIN -c $BAREOS_CONFIG -d 200" > "$BAREOS_LOG" 2>&1
        
        # Wait for startup and verify
        sleep 3
        if [ -f "$BAREOS_PID" ] && kill -0 $(cat "$BAREOS_PID") 2>/dev/null; then
            echo "Bareos File Daemon started successfully"
            exit 0
        else
            echo "Failed to start Bareos File Daemon"
            exit 1
        fi
        ;;
        
    stop)
        echo "Stopping Bareos File Daemon..."
        
        if [ -f "$BAREOS_PID" ]; then
            PID=$(cat "$BAREOS_PID")
            if kill -0 "$PID" 2>/dev/null; then
                # Graceful shutdown
                kill -TERM "$PID"
                
                # Wait up to 30 seconds for graceful shutdown
                for i in {1..30}; do
                    if ! kill -0 "$PID" 2>/dev/null; then
                        rm -f "$BAREOS_PID"
                        echo "Bareos File Daemon stopped successfully"
                        exit 0
                    fi
                    sleep 1
                done
                
                # Force kill if still running
                kill -KILL "$PID" 2>/dev/null
                rm -f "$BAREOS_PID"
                echo "Bareos File Daemon force stopped"
            else
                rm -f "$BAREOS_PID"
                echo "Bareos File Daemon was not running"
            fi
        else
            echo "Bareos File Daemon is not running"
        fi
        exit 0
        ;;
        
    status)
        if [ -f "$BAREOS_PID" ] && kill -0 $(cat "$BAREOS_PID") 2>/dev/null; then
            echo "Bareos File Daemon is running (PID: $(cat "$BAREOS_PID"))"
            exit 0
        else
            echo "Bareos File Daemon is not running"
            exit 1
        fi
        ;;
        
    reload)
        echo "Reloading Bareos File Daemon configuration..."
        if [ -f "$BAREOS_PID" ] && kill -0 $(cat "$BAREOS_PID") 2>/dev/null; then
            kill -HUP $(cat "$BAREOS_PID")
            echo "Configuration reloaded"
        else
            echo "Bareos File Daemon is not running"
            exit 1
        fi
        ;;
        
    *)
        echo "Usage: $0 {start|stop|status|reload}"
        exit 1
        ;;
esac